import z,{Fragment as xe,createContext as ue,createRef as Ce,useCallback as Oe,useContext as pe,useEffect as se,useMemo as _,useReducer as ge,useRef as S}from"react";import{useComputed as te}from'../../hooks/use-computed.js';import{useDisposables as ne}from'../../hooks/use-disposables.js';import{useEvent as C}from'../../hooks/use-event.js';import{useId as q}from'../../hooks/use-id.js';import{useIsoMorphicEffect as k}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as ye}from'../../hooks/use-latest-value.js';import{useOutsideClick as Re}from'../../hooks/use-outside-click.js';import{useResolveButtonType as ve}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as Q}from'../../hooks/use-sync-refs.js';import{useTreeWalker as Pe}from'../../hooks/use-tree-walker.js';import{calculateActiveIndex as Ae,Focus as y}from'../../utils/calculate-active-index.js';import{disposables as be}from'../../utils/disposables.js';import{forwardRefWithAs as H,render as G,compact as Ee,Features as de}from'../../utils/render.js';import{isDisabledReactIssue7711 as Se}from'../../utils/bugs.js';import{match as X}from'../../utils/match.js';import{objectToFormEntries as Ie}from'../../utils/form.js';import{sortByDomNode as Le}from'../../utils/focus-management.js';import{Hidden as Ve,Features as De}from'../../internal/hidden.js';import{useOpenClosed as Fe,State as ee,OpenClosedProvider as Me}from'../../internal/open-closed.js';import{Keys as v}from'../keyboard.js';import{useControllable as _e}from'../../hooks/use-controllable.js';import{useWatch as fe}from'../../hooks/use-watch.js';import{useTrackedPointer as he}from'../../hooks/use-tracked-pointer.js';import{isMobile as Be}from'../../utils/platform.js';var ke=(e=>(e[e.Open=0]="Open",e[e.Closed=1]="Closed",e))(ke||{}),we=(e=>(e[e.Single=0]="Single",e[e.Multi=1]="Multi",e))(we||{}),Ue=(e=>(e[e.Pointer=0]="Pointer",e[e.Other=1]="Other",e))(Ue||{}),Ne=(n=>(n[n.OpenCombobox=0]="OpenCombobox",n[n.CloseCombobox=1]="CloseCombobox",n[n.GoToOption=2]="GoToOption",n[n.RegisterOption=3]="RegisterOption",n[n.UnregisterOption=4]="UnregisterOption",n[n.RegisterLabel=5]="RegisterLabel",n))(Ne||{});function re(t,l=e=>e){let e=t.activeOptionIndex!==null?t.options[t.activeOptionIndex]:null,r=Le(l(t.options.slice()),b=>b.dataRef.current.domRef.current),i=e?r.indexOf(e):null;return i===-1&&(i=null),{options:r,activeOptionIndex:i}}let He={[1](t){var l;return(l=t.dataRef.current)!=null&&l.disabled||t.comboboxState===1?t:{...t,activeOptionIndex:null,comboboxState:1}},[0](t){var e;if((e=t.dataRef.current)!=null&&e.disabled||t.comboboxState===0)return t;let l=t.activeOptionIndex;if(t.dataRef.current){let{isSelected:r}=t.dataRef.current,i=t.options.findIndex(b=>r(b.dataRef.current.value));i!==-1&&(l=i)}return{...t,comboboxState:0,activeOptionIndex:l}},[2](t,l){var i,b,n,d;if((i=t.dataRef.current)!=null&&i.disabled||(b=t.dataRef.current)!=null&&b.optionsRef.current&&!((n=t.dataRef.current)!=null&&n.optionsPropsRef.current.static)&&t.comboboxState===1)return t;let e=re(t);if(e.activeOptionIndex===null){let o=e.options.findIndex(u=>!u.dataRef.current.disabled);o!==-1&&(e.activeOptionIndex=o)}let r=Ae(l,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:o=>o.id,resolveDisabled:o=>o.dataRef.current.disabled});return{...t,...e,activeOptionIndex:r,activationTrigger:(d=l.trigger)!=null?d:1}},[3]:(t,l)=>{var b,n;let e={id:l.id,dataRef:l.dataRef},r=re(t,d=>[...d,e]);t.activeOptionIndex===null&&(b=t.dataRef.current)!=null&&b.isSelected(l.dataRef.current.value)&&(r.activeOptionIndex=r.options.indexOf(e));let i={...t,...r,activationTrigger:1};return(n=t.dataRef.current)!=null&&n.__demoMode&&t.dataRef.current.value===void 0&&(i.activeOptionIndex=0),i},[4]:(t,l)=>{let e=re(t,r=>{let i=r.findIndex(b=>b.id===l.id);return i!==-1&&r.splice(i,1),r});return{...t,...e,activationTrigger:1}},[5]:(t,l)=>({...t,labelId:l.id})},ae=ue(null);ae.displayName="ComboboxActionsContext";function Y(t){let l=pe(ae);if(l===null){let e=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(e,Y),e}return l}let le=ue(null);le.displayName="ComboboxDataContext";function j(t){let l=pe(le);if(l===null){let e=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(e,j),e}return l}function Ge(t,l){return X(l.type,He,t,l)}let Xe=xe;function je(t,l){let{value:e,defaultValue:r,onChange:i,form:b,name:n,by:d=(p,T)=>p===T,disabled:o=!1,__demoMode:u=!1,nullable:P=!1,multiple:f=!1,...E}=t,[c=f?[]:void 0,g]=_e(e,i,r),[m,x]=ge(Ge,{dataRef:Ce(),comboboxState:u?0:1,options:[],activeOptionIndex:null,activationTrigger:1,labelId:null}),V=S(!1),h=S({static:!1,hold:!1}),w=S(null),U=S(null),N=S(null),J=S(null),F=C(typeof d=="string"?(p,T)=>{let R=d;return(p==null?void 0:p[R])===(T==null?void 0:T[R])}:d),B=Oe(p=>X(s.mode,{[1]:()=>c.some(T=>F(T,p)),[0]:()=>F(c,p)}),[c]),s=_(()=>({...m,optionsPropsRef:h,labelRef:w,inputRef:U,buttonRef:N,optionsRef:J,value:c,defaultValue:r,disabled:o,mode:f?1:0,get activeOptionIndex(){if(V.current&&m.activeOptionIndex===null&&m.options.length>0){let p=m.options.findIndex(T=>!T.dataRef.current.disabled);if(p!==-1)return p}return m.activeOptionIndex},compare:F,isSelected:B,nullable:P,__demoMode:u}),[c,r,o,f,P,u,m]),O=S(s.activeOptionIndex!==null?s.options[s.activeOptionIndex]:null);se(()=>{let p=s.activeOptionIndex!==null?s.options[s.activeOptionIndex]:null;O.current!==p&&(O.current=p)}),k(()=>{m.dataRef.current=s},[s]),Re([s.buttonRef,s.inputRef,s.optionsRef],()=>oe.closeCombobox(),s.comboboxState===0);let a=_(()=>({open:s.comboboxState===0,disabled:o,activeIndex:s.activeOptionIndex,activeOption:s.activeOptionIndex===null?null:s.options[s.activeOptionIndex].dataRef.current.value,value:c}),[s,o,c]),L=C(p=>{let T=s.options.find(R=>R.id===p);T&&W(T.dataRef.current.value)}),I=C(()=>{if(s.activeOptionIndex!==null){let{dataRef:p,id:T}=s.options[s.activeOptionIndex];W(p.current.value),oe.goToOption(y.Specific,T)}}),K=C(()=>{x({type:0}),V.current=!0}),A=C(()=>{x({type:1}),V.current=!1}),D=C((p,T,R)=>(V.current=!1,p===y.Specific?x({type:2,focus:y.Specific,id:T,trigger:R}):x({type:2,focus:p,trigger:R}))),M=C((p,T)=>(x({type:3,id:p,dataRef:T}),()=>{var R;((R=O.current)==null?void 0:R.id)===p&&(V.current=!0),x({type:4,id:p})})),ce=C(p=>(x({type:5,id:p}),()=>x({type:5,id:null}))),W=C(p=>X(s.mode,{[0](){return g==null?void 0:g(p)},[1](){let T=s.value.slice(),R=T.findIndex($=>F($,p));return R===-1?T.push(p):T.splice(R,1),g==null?void 0:g(T)}})),oe=_(()=>({onChange:W,registerOption:M,registerLabel:ce,goToOption:D,closeCombobox:A,openCombobox:K,selectActiveOption:I,selectOption:L}),[]),Te=l===null?{}:{ref:l},Z=S(null),me=ne();return se(()=>{Z.current&&r!==void 0&&me.addEventListener(Z.current,"reset",()=>{W(r)})},[Z,W]),z.createElement(ae.Provider,{value:oe},z.createElement(le.Provider,{value:s},z.createElement(Me,{value:X(s.comboboxState,{[0]:ee.Open,[1]:ee.Closed})},n!=null&&c!=null&&Ie({[n]:c}).map(([p,T],R)=>z.createElement(Ve,{features:De.Hidden,ref:R===0?$=>{var ie;Z.current=(ie=$==null?void 0:$.closest("form"))!=null?ie:null}:void 0,...Ee({key:p,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:b,name:p,value:T})})),G({ourProps:Te,theirProps:E,slot:a,defaultTag:Xe,name:"Combobox"}))))}let Je="input";function Ke(t,l){var F,B,s,O;let e=q(),{id:r=`headlessui-combobox-input-${e}`,onChange:i,displayValue:b,type:n="text",...d}=t,o=j("Combobox.Input"),u=Y("Combobox.Input"),P=Q(o.inputRef,l),f=S(!1),E=ne(),c=function(){var a;return typeof b=="function"&&o.value!==void 0?(a=b(o.value))!=null?a:"":typeof o.value=="string"?o.value:""}();fe(([a,L],[I,K])=>{if(f.current)return;let A=o.inputRef.current;A&&((K===0&&L===1||a!==I)&&(A.value=a),requestAnimationFrame(()=>{if(f.current||!A)return;let{selectionStart:D,selectionEnd:M}=A;Math.abs((M!=null?M:0)-(D!=null?D:0))===0&&D===0&&A.setSelectionRange(A.value.length,A.value.length)}))},[c,o.comboboxState]),fe(([a],[L])=>{if(a===0&&L===1){if(f.current)return;let I=o.inputRef.current;if(!I)return;let K=I.value,{selectionStart:A,selectionEnd:D,selectionDirection:M}=I;I.value="",I.value=K,M!==null?I.setSelectionRange(A,D,M):I.setSelectionRange(A,D)}},[o.comboboxState]);let g=S(!1),m=C(()=>{g.current=!0}),x=C(()=>{E.nextFrame(()=>{g.current=!1})}),V=C(a=>{switch(f.current=!0,a.key){case v.Backspace:case v.Delete:if(o.mode!==0||!o.nullable)return;let L=a.currentTarget;E.requestAnimationFrame(()=>{L.value===""&&(u.onChange(null),o.optionsRef.current&&(o.optionsRef.current.scrollTop=0),u.goToOption(y.Nothing))});break;case v.Enter:if(f.current=!1,o.comboboxState!==0||g.current)return;if(a.preventDefault(),a.stopPropagation(),o.activeOptionIndex===null){u.closeCombobox();return}u.selectActiveOption(),o.mode===0&&u.closeCombobox();break;case v.ArrowDown:return f.current=!1,a.preventDefault(),a.stopPropagation(),X(o.comboboxState,{[0]:()=>{u.goToOption(y.Next)},[1]:()=>{u.openCombobox()}});case v.ArrowUp:return f.current=!1,a.preventDefault(),a.stopPropagation(),X(o.comboboxState,{[0]:()=>{u.goToOption(y.Previous)},[1]:()=>{u.openCombobox(),E.nextFrame(()=>{o.value||u.goToOption(y.Last)})}});case v.Home:if(a.shiftKey)break;return f.current=!1,a.preventDefault(),a.stopPropagation(),u.goToOption(y.First);case v.PageUp:return f.current=!1,a.preventDefault(),a.stopPropagation(),u.goToOption(y.First);case v.End:if(a.shiftKey)break;return f.current=!1,a.preventDefault(),a.stopPropagation(),u.goToOption(y.Last);case v.PageDown:return f.current=!1,a.preventDefault(),a.stopPropagation(),u.goToOption(y.Last);case v.Escape:return f.current=!1,o.comboboxState!==0?void 0:(a.preventDefault(),o.optionsRef.current&&!o.optionsPropsRef.current.static&&a.stopPropagation(),u.closeCombobox());case v.Tab:if(f.current=!1,o.comboboxState!==0)return;o.mode===0&&u.selectActiveOption(),u.closeCombobox();break}}),h=C(a=>{i==null||i(a),u.openCombobox()}),w=C(()=>{f.current=!1}),U=te(()=>{if(o.labelId)return[o.labelId].join(" ")},[o.labelId]),N=_(()=>({open:o.comboboxState===0,disabled:o.disabled}),[o]),J={ref:P,id:r,role:"combobox",type:n,"aria-controls":(F=o.optionsRef.current)==null?void 0:F.id,"aria-expanded":o.comboboxState===0,"aria-activedescendant":o.activeOptionIndex===null||(B=o.options[o.activeOptionIndex])==null?void 0:B.id,"aria-labelledby":U,"aria-autocomplete":"list",defaultValue:(O=(s=t.defaultValue)!=null?s:o.defaultValue!==void 0?b==null?void 0:b(o.defaultValue):null)!=null?O:o.defaultValue,disabled:o.disabled,onCompositionStart:m,onCompositionEnd:x,onKeyDown:V,onChange:h,onBlur:w};return G({ourProps:J,theirProps:d,slot:N,defaultTag:Je,name:"Combobox.Input"})}let We="button";function $e(t,l){var g;let e=j("Combobox.Button"),r=Y("Combobox.Button"),i=Q(e.buttonRef,l),b=q(),{id:n=`headlessui-combobox-button-${b}`,...d}=t,o=ne(),u=C(m=>{switch(m.key){case v.ArrowDown:return m.preventDefault(),m.stopPropagation(),e.comboboxState===1&&r.openCombobox(),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})});case v.ArrowUp:return m.preventDefault(),m.stopPropagation(),e.comboboxState===1&&(r.openCombobox(),o.nextFrame(()=>{e.value||r.goToOption(y.Last)})),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})});case v.Escape:return e.comboboxState!==0?void 0:(m.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&m.stopPropagation(),r.closeCombobox(),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})}));default:return}}),P=C(m=>{if(Se(m.currentTarget))return m.preventDefault();e.comboboxState===0?r.closeCombobox():(m.preventDefault(),r.openCombobox()),o.nextFrame(()=>{var x;return(x=e.inputRef.current)==null?void 0:x.focus({preventScroll:!0})})}),f=te(()=>{if(e.labelId)return[e.labelId,n].join(" ")},[e.labelId,n]),E=_(()=>({open:e.comboboxState===0,disabled:e.disabled,value:e.value}),[e]),c={ref:i,id:n,type:ve(t,e.buttonRef),tabIndex:-1,"aria-haspopup":"listbox","aria-controls":(g=e.optionsRef.current)==null?void 0:g.id,"aria-expanded":e.comboboxState===0,"aria-labelledby":f,disabled:e.disabled,onClick:P,onKeyDown:u};return G({ourProps:c,theirProps:d,slot:E,defaultTag:We,name:"Combobox.Button"})}let qe="label";function Qe(t,l){let e=q(),{id:r=`headlessui-combobox-label-${e}`,...i}=t,b=j("Combobox.Label"),n=Y("Combobox.Label"),d=Q(b.labelRef,l);k(()=>n.registerLabel(r),[r]);let o=C(()=>{var f;return(f=b.inputRef.current)==null?void 0:f.focus({preventScroll:!0})}),u=_(()=>({open:b.comboboxState===0,disabled:b.disabled}),[b]);return G({ourProps:{ref:d,id:r,onClick:o},theirProps:i,slot:u,defaultTag:qe,name:"Combobox.Label"})}let Ye="ul",Ze=de.RenderStrategy|de.Static;function ze(t,l){let e=q(),{id:r=`headlessui-combobox-options-${e}`,hold:i=!1,...b}=t,n=j("Combobox.Options"),d=Q(n.optionsRef,l),o=Fe(),u=(()=>o!==null?(o&ee.Open)===ee.Open:n.comboboxState===0)();k(()=>{var c;n.optionsPropsRef.current.static=(c=t.static)!=null?c:!1},[n.optionsPropsRef,t.static]),k(()=>{n.optionsPropsRef.current.hold=i},[n.optionsPropsRef,i]),Pe({container:n.optionsRef.current,enabled:n.comboboxState===0,accept(c){return c.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:c.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(c){c.setAttribute("role","none")}});let P=te(()=>{var c,g;return(g=n.labelId)!=null?g:(c=n.buttonRef.current)==null?void 0:c.id},[n.labelId,n.buttonRef.current]),f=_(()=>({open:n.comboboxState===0}),[n]),E={"aria-labelledby":P,role:"listbox","aria-multiselectable":n.mode===1?!0:void 0,id:r,ref:d};return G({ourProps:E,theirProps:b,slot:f,defaultTag:Ye,features:Ze,visible:u,name:"Combobox.Options"})}let eo="li";function oo(t,l){var B,s;let e=q(),{id:r=`headlessui-combobox-option-${e}`,disabled:i=!1,value:b,...n}=t,d=j("Combobox.Option"),o=Y("Combobox.Option"),u=d.activeOptionIndex!==null?d.options[d.activeOptionIndex].id===r:!1,P=d.isSelected(b),f=S(null),E=ye({disabled:i,value:b,domRef:f,textValue:(s=(B=f.current)==null?void 0:B.textContent)==null?void 0:s.toLowerCase()}),c=Q(l,f),g=C(()=>o.selectOption(r));k(()=>o.registerOption(r,E),[E,r]);let m=S(!d.__demoMode);k(()=>{if(!d.__demoMode)return;let O=be();return O.requestAnimationFrame(()=>{m.current=!0}),O.dispose},[]),k(()=>{if(d.comboboxState!==0||!u||!m.current||d.activationTrigger===0)return;let O=be();return O.requestAnimationFrame(()=>{var a,L;(L=(a=f.current)==null?void 0:a.scrollIntoView)==null||L.call(a,{block:"nearest"})}),O.dispose},[f,u,d.comboboxState,d.activationTrigger,d.activeOptionIndex]);let x=C(O=>{if(i)return O.preventDefault();g(),d.mode===0&&o.closeCombobox(),Be()||requestAnimationFrame(()=>{var a;return(a=d.inputRef.current)==null?void 0:a.focus()})}),V=C(()=>{if(i)return o.goToOption(y.Nothing);o.goToOption(y.Specific,r)}),h=he(),w=C(O=>h.update(O)),U=C(O=>{h.wasMoved(O)&&(i||u||o.goToOption(y.Specific,r,0))}),N=C(O=>{h.wasMoved(O)&&(i||u&&(d.optionsPropsRef.current.hold||o.goToOption(y.Nothing)))}),J=_(()=>({active:u,selected:P,disabled:i}),[u,P,i]);return G({ourProps:{id:r,ref:c,role:"option",tabIndex:i===!0?void 0:-1,"aria-disabled":i===!0?!0:void 0,"aria-selected":P,disabled:void 0,onClick:x,onFocus:V,onPointerEnter:w,onMouseEnter:w,onPointerMove:U,onMouseMove:U,onPointerLeave:N,onMouseLeave:N},theirProps:n,slot:J,defaultTag:eo,name:"Combobox.Option"})}let to=H(je),no=H($e),ro=H(Ke),ao=H(Qe),lo=H(ze),io=H(oo),Wo=Object.assign(to,{Input:ro,Button:no,Label:ao,Options:lo,Option:io});export{Wo as Combobox};
